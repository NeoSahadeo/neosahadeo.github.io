import adapter from '@sveltejs/adapter-static';
import { vitePreprocess } from '@sveltejs/vite-plugin-svelte';
import { mdsvex, escapeSvelte } from 'mdsvex';
import { createHighlighter } from 'shiki';

const theme = 'github-light';
const highlighter = await createHighlighter({
	themes: [theme],
	langs: [
		'abap',
		'actionscript-3',
		'ada',
		'angular-html',
		'angular-ts',
		'apache',
		'apex',
		'apl',
		'applescript',
		'ara',
		'asciidoc',
		'asm',
		'astro',
		'awk',
		'ballerina',
		'bash',
		'bat',
		'beancount',
		'berry',
		'bibtex',
		'bicep',
		'blade',
		'bsl',
		'c',
		'cadence',
		'cairo',
		'clarity',
		'clj',
		'clojure',
		'cmake',
		'cobol',
		'codeowners',
		'codeql',
		'coffee',
		'common-lisp',
		'coq',
		'cpp',
		'crystal',
		'csharp',
		'css',
		'csv',
		'cue',
		'cypher',
		'd',
		'dart',
		'dax',
		'desktop',
		'diff',
		'docker',
		'dotenv',
		'dream-maker',
		'edge',
		'elixir',
		'elm',
		'emacs-lisp',
		'erb',
		'erlang',
		'fennel',
		'fish',
		'fluent',
		'fortran-fixed-form',
		'fortran-free-form',
		'fsharp',
		'fsl',
		'gdresource',
		'gdscript',
		'gdshader',
		'genie',
		'gherkin',
		'gleam',
		'glimmer-js',
		'glimmer-ts',
		'glsl',
		'gnuplot',
		'go',
		'graphql',
		'groovy',
		'hack',
		'haml',
		'handlebars',
		'haskell',
		'haxe',
		'hcl',
		'hjson',
		'hlsl',
		'html',
		'http',
		'hxml',
		'hy',
		'imba',
		'ini',
		'java',
		'javascript',
		'jinja',
		'jison',
		'json',
		'json5',
		'jsonc',
		'jsonl',
		'jsonnet',
		'jssm',
		'jsx',
		'julia',
		'kotlin',
		'kusto',
		'latex',
		'lean',
		'less',
		'liquid',
		'llvm',
		'log',
		'logo',
		'lua',
		'luau',
		'make',
		'markdown',
		'marko',
		'matlab',
		'mdc',
		'mdx',
		'mermaid',
		'mipsasm',
		'mojo',
		'move',
		'narrat',
		'nextflow',
		'nginx',
		'nim',
		'nix',
		'nushell',
		'objective-c',
		'objective-cpp',
		'ocaml',
		'pascal',
		'perl',
		'php',
		'plsql',
		'po',
		'polar',
		'postcss',
		'powerquery',
		'powershell',
		'prisma',
		'prolog',
		'proto',
		'pug',
		'puppet',
		'purescript',
		'python',
		'qml',
		'qmldir',
		'qss',
		'r',
		'racket',
		'raku',
		'razor',
		'reg',
		'regexp',
		'rel',
		'riscv',
		'rst',
		'ruby',
		'rust',
		'sas',
		'sass',
		'scala',
		'scheme',
		'scss',
		'sdbl',
		'shaderlab',
		'shellscript',
		'shellsession',
		'smalltalk',
		'solidity',
		'soy',
		'sparql',
		'splunk',
		'sql',
		'ssh-config',
		'stata',
		'stylus',
		'svelte',
		'system-verilog',
		'systemd',
		'talonscript',
		'tasl',
		'tcl',
		'templ',
		'terraform',
		'tex',
		'toml',
		'ts-tags',
		'tsv',
		'tsx',
		'turtle',
		'twig',
		'typescript',
		'typespec',
		'typst',
		'v',
		'vala',
		'vb',
		'verilog',
		'vhdl',
		'viml',
		'vue',
		'vue-html',
		'vyper',
		'wasm',
		'wenyan',
		'wgsl',
		'wikitext',
		'wit',
		'wolfram',
		'xml',
		'xsl',
		'yaml',
		'zenscript',
		'zig',
		'zsh'
	]
});

const mdsvex_config = {
	extensions: ['.md'],
	highlight: {
		highlighter: async (code, lang = 'text') => {
			const html = escapeSvelte(highlighter.codeToHtml(code, { lang, theme }));
			return `{@html \`${html}\` }`;
		}
	}
};

/** @type {import('@sveltejs/kit').Config} */
const config = {
	extensions: ['.svelte', '.md'],
	preprocess: [vitePreprocess(), mdsvex(mdsvex_config)],

	kit: {
		adapter: adapter({
			pages: 'build',
			assets: 'build',
			fallback: undefined,
			precompress: false,
			strict: false
		}),
		prerender: {
			handleHttpError: ({ path, referrer, message }) => {
				// ignore deliberate link to shiny 404 page
				if (path === '/not-found' && referrer === '/blog/how-we-built-our-404-page') {
					return;
				}
			}
		}
	}
};

export default config;
